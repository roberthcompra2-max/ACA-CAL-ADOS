<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACA - Controle de Estoque</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=JetBrains+Mono:wght@700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; color: #1e293b; overflow-x: hidden; }
        thead th { position: sticky; top: 0; background: #1e1b4b; color: #fbbf24; z-index: 40; padding: 6px; font-size: 9px; text-transform: uppercase; border-bottom: 2px solid #fbbf24; }
        .btn-active { background-color: #fbbf24 !important; color: #1e1b4b !important; font-weight: 800; }
        .dashboard-compact { background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%); }
        .custom-scroll::-webkit-scrollbar { display: none; }
        .group-bg-1 { background-color: #ffffff; }
        .group-bg-2 { background-color: #e2e8f0; } 

        @media print { 
            .no-print { display: none !important; } 
            header { display: none !important; }
            body { background: white !important; color: black !important; padding: 0 !important; }
            table { border-collapse: collapse !important; width: 100% !important; }
            thead th { background: white !important; color: black !important; border: 1px solid black !important; position: static !important; }
            td { border: 1px solid black !important; color: black !important; padding: 4px !important; }
            .text-indigo-700, .text-red-600, .text-red-700, .text-indigo-900, .text-slate-900 { color: black !important; }
            
            /* TIRA O NEGRITO DA DESCRI√á√ÉO APENAS NA IMPRESS√ÉO */
            .desc-produto { font-weight: 400 !important; }
        }
    </style>
</head>
<body class="pb-8">

    <div id="loginScreen" class="fixed inset-0 z-[100] bg-slate-950 flex items-center justify-center p-6 no-print">
        <div class="bg-white p-6 rounded-3xl shadow-2xl w-full max-w-[280px] text-center border-t-4 border-amber-400">
            <h1 class="text-lg font-black text-slate-900 mb-1 uppercase tracking-tighter">ACA ESTOQUE</h1>
            <input type="password" id="passInput" placeholder="Senha" class="w-full p-2.5 bg-slate-100 rounded-xl border border-slate-200 mb-3 font-bold text-center outline-none">
            <button onclick="verificarLogin()" class="w-full bg-indigo-950 text-white font-black py-2.5 rounded-xl uppercase text-xs tracking-widest active:scale-95 transition-all">Entrar</button>
        </div>
    </div>

    <div id="mainContent" class="hidden">
        <header class="dashboard-compact text-white p-2 sticky top-0 z-50 shadow-md no-print">
            <div class="max-w-7xl mx-auto">
                <div class="flex justify-between items-center mb-2 relative">
                    <h1 id="brandName" class="text-xs font-black italic uppercase tracking-tighter">ACA <span class="text-amber-400">ESTOQUE</span></h1>
                    <div id="tituloAmostraCentral" class="hidden absolute left-1/2 -translate-x-1/2 text-sm font-black text-amber-400 tracking-[0.2em] uppercase">AMOSTRAS</div>
                    <div class="flex gap-1.5">
                        <button onclick="window.print()" class="bg-slate-700 text-white px-2 py-1 rounded-md font-black text-[9px] uppercase hover:bg-slate-600">üñ®Ô∏è IMPRIMIR</button>
                        <button onclick="gerarAmostras()" id="btnAmostra" class="bg-cyan-600 text-white px-2 py-1 rounded-md font-black text-[9px] uppercase">üìã AMOSTRAS</button>
                        <label class="bg-amber-400 text-indigo-950 px-2 py-1 rounded-md cursor-pointer font-black text-[9px] uppercase">
                            ATUALIZAR <input type="file" id="fileInput" accept=".txt" class="hidden" />
                        </label>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-1.5 mb-2">
                    <div class="bg-white/5 p-1.5 rounded-lg border border-white/10 flex justify-between items-center px-3">
                        <span id="labelPares" class="text-[8px] font-bold text-indigo-300 uppercase italic">Pares:</span>
                        <span id="resumoPecas" class="text-sm font-black text-white font-mono">0</span>
                    </div>
                    <div class="bg-white/5 p-1.5 rounded-lg border border-white/10 flex justify-between items-center px-3">
                        <span id="resumoValor" class="text-sm font-black text-amber-400 font-mono">R$ 0,00</span>
                    </div>
                </div>

                <div class="flex gap-1.5 mb-2">
                    <div id="areaPrecos" class="flex gap-1.5 w-1/3">
                        <input type="number" id="minPrice" oninput="aplicarFiltrosComDebounce()" placeholder="Min" class="w-1/2 p-1.5 rounded-lg bg-white/10 border border-white/20 text-white font-bold text-[10px] outline-none" />
                        <input type="number" id="maxPrice" oninput="aplicarFiltrosComDebounce()" placeholder="Max" class="w-1/2 p-1.5 rounded-lg bg-white/10 border border-white/20 text-white font-bold text-[10px] outline-none" />
                    </div>
                    <input type="text" id="searchInput" oninput="aplicarFiltrosComDebounce()" placeholder="Busca... (TAM:35 ou COR:PRETO)" class="flex-1 p-1.5 rounded-lg bg-slate-900/60 border border-indigo-400/30 text-white font-bold text-[10px] outline-none" />
                </div>

                <div class="flex gap-1 overflow-x-auto pb-1 custom-scroll items-center">
                    <button id="btnTodosAnos" onclick="filtrarAno(null, this)" class="btn-ano btn-active flex-shrink-0 bg-white/10 px-3 py-1.5 rounded-md text-[8px] font-black uppercase">Geral</button>
                    <button onclick="filtrarAno('26', this)" class="btn-ano flex-shrink-0 bg-white/10 px-4 py-1.5 rounded-md text-[8px] font-black uppercase">2026</button>
                    <button onclick="filtrarAno('25', this)" class="btn-ano flex-shrink-0 bg-white/10 px-4 py-1.5 rounded-md text-[8px] font-black uppercase">2025</button>
                    <button onclick="filtrarAno('24', this)" class="btn-ano flex-shrink-0 bg-white/10 px-4 py-1.5 rounded-md text-[8px] font-black uppercase">2024</button>
                    <div class="w-px h-4 bg-white/20 mx-0.5"></div>
                    <button id="btnQtdTodos" onclick="filtrarQtd('min', 0, this)" class="btn-qtd btn-active flex-shrink-0 bg-white/10 px-3 py-1.5 rounded-md text-[8px] font-black uppercase">Todos</button>
                    <button id="btnPecaUnica" onclick="filtrarQtd('exato', 1, this)" class="btn-qtd flex-shrink-0 bg-indigo-500/40 text-white px-3 py-1.5 rounded-md text-[8px] font-black uppercase">Pe√ßa √önica</button>
                    <button id="btnMaisDois" onclick="filtrarQtd('min', 2, this)" class="btn-qtd flex-shrink-0 bg-emerald-600/40 text-white px-3 py-1.5 rounded-md text-[8px] font-black uppercase">+2 Pares</button>
                    <button onclick="limparTudo()" class="ml-auto bg-red-500/30 text-white px-2 py-1.5 rounded-md text-[8px] font-black uppercase">Limpar</button>
                </div>
                
                <div class="text-[8px] text-amber-400/80 uppercase font-black text-right italic mt-1 pr-1">
                    √öLTIMO SYNC: <span id="lastSync" class="text-white">--/--</span>
                </div>
            </div>
        </header>

        <div class="max-w-7xl mx-auto px-0 bg-white">
            <table class="w-full border-collapse">
                <thead id="tableHeader"></thead>
                <tbody id="tableBody" class="text-[10px] font-medium"></tbody>
            </table>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCmnh6bYskf3kOon7i5tePMqZ6DVyWNwaA",
            authDomain: "estoque-aca.firebaseapp.com",
            databaseURL: "https://estoque-aca-default-rtdb.firebaseio.com/",
            projectId: "estoque-aca"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let dadosEstoque = [];
        let modoAmostra = false;
        let anoAtivo = null;
        let modoFiltroQtd = 'min';
        let valorFiltroQtd = 0;
        let timerBusca;

        function verificarLogin() {
            if (document.getElementById('passInput').value.toLowerCase() === 'aca') {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                monitorarNuvem();
            }
        }

        function monitorarNuvem() {
            db.ref('estoque_calcados/itens').on('value', (snap) => {
                dadosEstoque = snap.val() || [];
                aplicarFiltros();
            });
            db.ref('estoque_calcados/lastSync').on('value', (snap) => {
                if(snap.val()) document.getElementById('lastSync').textContent = snap.val();
            });
        }

        function aplicarFiltrosComDebounce() {
            clearTimeout(timerBusca);
            timerBusca = setTimeout(aplicarFiltros, 150);
        }

        function gerarAmostras() {
            modoAmostra = !modoAmostra;
            document.getElementById('btnAmostra').textContent = modoAmostra ? "‚¨ÖÔ∏è ESTOQUE" : "üìã AMOSTRAS";
            document.getElementById('tituloAmostraCentral').classList.toggle('hidden', !modoAmostra);
            document.getElementById('areaPrecos').classList.toggle('hidden', modoAmostra);
            document.getElementById('labelPares').textContent = modoAmostra ? "MODELOS:" : "PARES:";
            aplicarFiltros();
        }

        function filtrarAno(ano, btn) {
            document.querySelectorAll('.btn-ano').forEach(b => b.classList.remove('btn-active'));
            btn.classList.add('btn-active');
            anoAtivo = ano;
            aplicarFiltros();
        }

        function filtrarQtd(tipo, valor, btn) {
            document.querySelectorAll('.btn-qtd').forEach(b => b.classList.remove('btn-active'));
            btn.classList.add('btn-active');
            modoFiltroQtd = tipo;
            valorFiltroQtd = valor;
            aplicarFiltros();
        }

        function aplicarFiltros() {
            let buscaFull = document.getElementById('searchInput').value.toUpperCase();
            let filtroTam = null, filtroCor = null;
            
            if (buscaFull.includes('TAM:')) {
                const partes = buscaFull.split('TAM:');
                if(partes[1]) filtroTam = partes[1].split(' ')[0].trim();
            }
            if (buscaFull.includes('COR:')) {
                const partes = buscaFull.split('COR:');
                if(partes[1]) filtroCor = partes[1].split(' ')[0].trim();
            }

            let buscaTexto = buscaFull.replace(/TAM:\S+/g, '').replace(/COR:\S+/g, '').trim().toLowerCase();
            const termos = buscaTexto.split(' ').filter(t => t !== '');
            const minP = parseFloat(document.getElementById('minPrice').value) || 0;
            const maxP = parseFloat(document.getElementById('maxPrice').value) || Infinity;

            let listaBase = dadosEstoque.filter(i => {
                const tamItem = String(i.tam || '').trim().toUpperCase();
                const corItem = String(i.cor || '').trim().toUpperCase();
                const descItem = String(i.desc || '').toLowerCase();
                const nceItem = String(i.nce || '').toLowerCase();

                const matchTexto = termos.every(t => descItem.includes(t) || nceItem.includes(t) || corItem.toLowerCase().includes(t));
                const matchPreco = i.unitario >= minP && i.unitario <= maxP;
                const matchAno = anoAtivo ? i.ano === anoAtivo : true;
                const matchTam = filtroTam ? (tamItem === filtroTam) : true;
                const matchCor = filtroCor ? corItem.includes(filtroCor) : true;

                return matchTexto && matchPreco && matchAno && matchTam && matchCor && i.total > 0;
            });

            const somaPorNCE = {};
            listaBase.forEach(item => {
                if (!somaPorNCE[item.nce]) somaPorNCE[item.nce] = 0;
                somaPorNCE[item.nce] += item.total;
            });

            let listaFiltradaFinal = listaBase.filter(i => {
                const totalModelo = somaPorNCE[i.nce];
                return modoFiltroQtd === 'exato' ? totalModelo === valorFiltroQtd : totalModelo >= valorFiltroQtd;
            });

            if (modoAmostra) {
                const grupos = {};
                listaFiltradaFinal.forEach(item => {
                    const chave = `${item.nce}_${item.cor}`;
                    if (!grupos[chave]) grupos[chave] = [];
                    grupos[chave].push(item);
                });
                let listaAmostras = Object.values(grupos).map(itens => {
                    itens.sort((a, b) => parseInt(a.tam) - parseInt(b.tam));
                    return { ...itens[0], qtdTotalCor: itens.reduce((acc, cur) => acc + cur.total, 0) };
                });
                renderizar(listaAmostras, true);
                atualizarResumo(listaAmostras, true);
            } else {
                renderizar(listaFiltradaFinal, false);
                atualizarResumo(listaFiltradaFinal, false);
            }
        }

        function renderizar(lista, isAmostra) {
            const header = isAmostra ? 
                `<tr><th class="w-14">NCE</th><th class="text-left">DESC / COR</th><th class="w-10 text-center">TAM</th><th class="w-10 text-center">TOT</th><th class="w-20 text-right pr-2">VALOR</th></tr>` :
                `<tr><th class="w-14">NCE</th><th class="w-8">TAM</th><th class="text-left">DESCRI√á√ÉO / COR</th><th class="w-14">ESTOQUE</th><th class="w-20 text-right pr-2">PRE√áO</th></tr>`;
            
            document.getElementById('tableHeader').innerHTML = header;
            let html = "", ultimoNCE = "", currentClass = "group-bg-1";
            
            for (let i = 0; i < lista.length; i++) {
                const item = lista[i];
                if (item.nce !== ultimoNCE) { 
                    currentClass = (currentClass === "group-bg-1") ? "group-bg-2" : "group-bg-1"; 
                    ultimoNCE = item.nce; 
                }

                if (isAmostra) {
                    html += `<tr class="${currentClass} border-b border-slate-200">
                        <td class="p-3 text-center font-bold text-indigo-900">${item.nce}</td>
                        <td class="p-3"><div class="desc-produto font-black text-slate-900 uppercase text-[9px]">${item.desc}</div><div class="text-red-700 text-[8px] font-black uppercase">${item.cor}</div></td>
                        <td class="p-3 text-center"><span class="bg-amber-100 px-2 py-0.5 rounded-full font-black text-[9px]">${item.tam}</span></td>
                        <td class="p-3 text-center font-black text-slate-900 text-[9px]">${item.qtdTotalCor}</td>
                        <td class="p-3 text-right pr-2 font-mono text-indigo-900 font-black">R$ ${item.unitario.toFixed(2)}</td>
                    </tr>`;
                } else {
                    html += `<tr class="${currentClass} border-b border-slate-100">
                        <td class="p-2 text-center font-bold text-indigo-700">${item.nce}</td>
                        <td class="p-2 text-center font-black">${item.tam}</td>
                        <td class="p-2"><div class="desc-produto font-bold text-slate-800 uppercase text-[9px] leading-tight">${item.desc}</div><div class="text-red-600 text-[8px] font-black uppercase">${item.cor}</div></td>
                        <td class="p-2 text-center font-black text-slate-900">${item.total}</td>
                        <td class="p-2 text-right pr-2 font-mono text-indigo-900 font-bold">R$ ${item.unitario.toFixed(2)}</td>
                    </tr>`;
                }
            }
            document.getElementById('tableBody').innerHTML = html;
        }

        function atualizarResumo(lista, isAmostra) {
            let p = 0, v = 0;
            if(isAmostra) { p = lista.length; lista.forEach(i => v += (i.qtdTotalCor * i.unitario)); } 
            else { lista.forEach(i => { p += i.total; v += (i.total * i.unitario); }); }
            document.getElementById('resumoPecas').textContent = p;
            document.getElementById('resumoValor').textContent = v.toLocaleString('pt-br', {style: 'currency', currency: 'BRL'});
        }

        function limparTudo() {
            document.getElementById('searchInput').value = '';
            document.getElementById('minPrice').value = '';
            document.getElementById('maxPrice').value = '';
            anoAtivo = null; modoFiltroQtd = 'min'; valorFiltroQtd = 0;
            document.querySelectorAll('.btn-ano, .btn-qtd').forEach(b => b.classList.remove('btn-active'));
            document.getElementById('btnTodosAnos').classList.add('btn-active');
            document.getElementById('btnQtdTodos').classList.add('btn-active');
            aplicarFiltros();
        }

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const lines = event.target.result.split('\n');
                let temp = []; let uNCE = "";
                lines.forEach(line => {
                    if (line.length > 100 && line.includes('.00')) {
                        let nce = line.substring(6, 13).trim(); if (nce !== "") uNCE = nce;
                        let tam = line.substring(13, 18).trim();
                        let cor = line.substring(18, 39).trim();
                        let desc = line.substring(39, 85).trim();
                        let saldo = parseInt(line.substring(85, 97).trim().split('.')[0]) || 0;
                        let preco = parseFloat(line.substring(105, 118).trim().replace(',', '.'));
                        if (desc.length > 5) {
                            let ano = desc.includes('/25') ? '25' : (desc.includes('/26') ? '26' : '24');
                            temp.push({ nce: uNCE, tam, cor, desc, total: saldo, unitario: preco, ano });
                        }
                    }
                });
                const d = new Date();
                const f = d.toLocaleDateString('pt-br', {day:'2-digit', month:'2-digit'}) + ' ' + d.getHours().toString().padStart(2, '0') + ':' + d.getMinutes().toString().padStart(2, '0');
                db.ref('estoque_calcados').update({ itens: temp, lastSync: f }).then(() => alert("Sincronizado!"));
            };
            reader.readAsText(e.target.files[0]);
        });

        window.onload = monitorarNuvem;
    </script>
</body>
</html>
